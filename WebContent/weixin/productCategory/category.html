<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>分类</title>
    
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="stylesheet" href="/weixin/style/wap.min.css"/>
<script src="/weixin/js/zepto.min.js"></script>
<script src="/weixin/js/callbacks.js"></script>
<script src="/weixin/js/deferred.js"></script>
<script src="/weixin/js/handlebars.min.js"></script>
<script src="/weixin/js/lazyload.min.js"></script>
<script src="/weixin/js/iSlider.min.js"></script>
<script src="/weixin/js/iSlider.animate.min.js"></script>
<script src="/weixin/js/fly.min.js"></script>
<script src="/weixin/js/requestAnimationFrame.js"></script>
<script src="/weixin/js/iscroll.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>


  

</head>
<body ontouchstart>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<script type="text/html" id="tpl_toast">

    <!--BEGIN toast-->
    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-info-circle weui-icon_toast"></i>
            <p class="weui-toast__content">已完成</p>
        </div>
    </div>
    <!--end toast-->

    <!-- loading toast -->
    <div id="loadingToast" style="display:none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-loading weui-icon_toast"></i>
            <p class="weui-toast__content">努力加载</p>
        </div>
    </div>

</script>
<script type="text/html" id="tpl_dialog">

    <!--BEGIN dialog1-->
    <div id="dialog1" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title">弹窗标题</strong></div>
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default">否</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">是</a>
            </div>
        </div>
    </div>
    <!--END dialog1-->
    <!--BEGIN dialog2-->
    <div id="dialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">知道了</a>
            </div>
        </div>
    </div>
    <!--END dialog2-->

</script>
<div class="container" id="container"></div>

<!--分类首页-->
<script type="text/html" id="tpl_category">
<div class="page">
    

    <!--BEGIN toast-->
    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-info-circle weui-icon_toast"></i>
            <p class="weui-toast__content">已完成</p>
        </div>
    </div>
    <!--end toast-->

    <!-- loading toast -->
    <div id="loadingToast" style="display:none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <!--<i class="weui-loading weui-icon_toast"></i>-->
            <p class="weui-toast__content">努力加载</p>
        </div>
    </div>


    

    <!--BEGIN dialog1-->
    <div id="dialog1" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title">操作提示</strong></div>
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default">否</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">是</a>
            </div>
        </div>
    </div>
    <!--END dialog1-->
    <!--BEGIN dialog2-->
    <div id="dialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">知道了</a>
            </div>
        </div>
    </div>
    <!--END dialog2-->


    <div class="page__bd pagescroll-rap" style="height: 100%;">
        <div class="weui-tab" >
            <!-- search-->
            <div class="weui-search-bar" id="searchBar">
                <form class="weui-search-bar__form">
                    <div class="weui-search-bar__box">
                        <i class="weui-icon-search"></i>
                        <input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索" required="">
                        <a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
                    </div>
                    <label class="weui-search-bar__label" id="searchText">
                        <i class="weui-icon-search"></i>
                        <span>搜索</span>
                    </label>
                </form>
                <a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
            </div>
            <!--分类栏ad-->

            <!-- search end-->
            <div class="weui-tab__panel" style="background:#fff">

                <div class="category">

                    <div class="category-ctn-left" id="silder-left" style="visibility: visible;">
                    </div>
                    <div class="category-ctn-right" id="silder-right">
                        <div class="jd_category_ad">
                            <a href="javascrfipt:;">
                                <img src="../images/limit-seckill_title.png">
                            </a>
                        </div>
                        <ul class="am-list" id="subProductCategory">
                        </ul>
                    </div>
                </div>

            </div>
            

    <div class="weui-tabbar foot_menu" style="position: fixed;">
        <a href="../home/index.html" class="weui-tabbar__item weui-bar__item_on" id="nav1">
            <i class="weui-tabbar__icon iconfont icon-l-home"></i>
            <p class="weui-tabbar__label">首页</p>
        </a>
        <a href="../productCategory/category.html" class="weui-tabbar__item" id="nav2">
            <i class="weui-tabbar__icon iconfont icon-l-classify"></i>
            <p class="weui-tabbar__label">分类</p>
        </a>
        <!--<a href="../nearby/nearby.html" class="weui-tabbar__item" id="nav3">
            <i class="weui-tabbar__icon iconfont icon-l-location"></i>
            <p class="weui-tabbar__label">附近</p>
        </a>-->
        <a href="../carts/cart.html" class="weui-tabbar__item" id="nav4">
            <i class="weui-tabbar__icon iconfont icon-cart"></i>
            <p class="weui-tabbar__label">购物车</p>
        </a>
        <a href="../index/check/login.jhtml" class="weui-tabbar__item " id="nav5">
            <i class="weui-tabbar__icon iconfont icon-l-me"></i>
            <p class="weui-tabbar__label">我的</p>
        </a>
    </div>
    <script type="text/javascript" class="tabbar js_show">
        $(function(){
            var str = window.location.href;
            var index = str .lastIndexOf("\/");
            str  = str .substring(index + 1, str .length);
            if(str=="index.html"){
                $("#nav1").addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
            }
            else if(str=="category.html"){
                $("#nav2").addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
            }
            else if(str.indexOf('nearby.html')!=-1){
                $("#nav3").addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
            }
            else if(str=="cart.html"){
                $("#nav4").addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');
            }
            else if(str=="member-home.html" || str=="redPacket.html"){
                $("#nav5").addClass('weui-bar__item_on').siblings('.weui-bar__item_on').removeClass('weui-bar__item_on');

            }
        });
    </script>

        </div>
    </div>
</div>


<!--右边分类模版-->
<script type="text/x-handlebars-template" id="wap-list-item">
    {{#each this}}
    {{#if childrens}}
    <li>
        <ul class="category-product">
            <p class="category-title Ftext">{{name}}</p>
            {{#each childrens}}
            <li>
                <a href="javascript:;" class="aproductReasult" data-id="{{id}}">
                    <p>
                        {{#compare image '!=' ""}}
                        <img src="{{image}}" class="22"/>
                        {{/compare}}
                        {{#compare image '==' ""}}
                        <img src="../images/placeholder/pic_article.png" class="11"/>
                        {{/compare}}
                    </p>
                    <p class="f12">{{name}}</p>
                </a>
            </li>
            {{/each}}
        </ul>
    </li>
    {{else}}
    <li class="category-title Ftext num">
        <!--<a href="productReasult.html?category={{id}}">-->
        <p class="f12">{{name}}</p>
        <!--</a>-->
    </li>
    {{/if}}
    {{/each}}
</script>


<!--左边分类模版-->
<script type="text/x-handlebars-template" id="Categorys">
    <ul class="am-lists class-items"  id="rootProductCategory">
        {{#each this}}
        <li data-id="{{id}}" class="cage" >
            <a>{{name}}</a>
        </li>
        {{/each}}
    </ul>
</script>

</script>
<!--分类点进去的产品列表页-->
<script type="text/html" id="tpl_productReasult">
<div class="page">
    

    <!--BEGIN toast-->
    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-info-circle weui-icon_toast"></i>
            <p class="weui-toast__content">已完成</p>
        </div>
    </div>
    <!--end toast-->

    <!-- loading toast -->
    <div id="loadingToast" style="display:none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <!--<i class="weui-loading weui-icon_toast"></i>-->
            <p class="weui-toast__content">努力加载</p>
        </div>
    </div>


    

    <!--BEGIN dialog1-->
    <div id="dialog1" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title">操作提示</strong></div>
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default">否</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">是</a>
            </div>
        </div>
    </div>
    <!--END dialog1-->
    <!--BEGIN dialog2-->
    <div id="dialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">知道了</a>
            </div>
        </div>
    </div>
    <!--END dialog2-->


    <!--BEGIN actionSheet-选择规格-->
    <div id="actionSheet_choose_norms">

        <div class="weui-mask_transparent actionsheet__mask" style="opacity: 0;display: none;"></div>
        <div class="weui-actionsheet actionsheet">
            <div style="background:#fff">
                <div class="weui-cells shop">
                    <div class="weui-cell">
                        <div class="weui-cell__hd shop_logo">
                            <img id="acn_thumbnail" src=""/>
                        </div>
                        <div class="weui-cell__bd">
                            <h2 class="f14 clr-red" id="acn_price">￥0</h2>
                            <p class="f12">库存<span id="acn_stock"></span>件</p>
                            <p class="f12" id="acn_choose">已选</p>
                        </div>
                    </div>
                </div>
                <div class="weui-cells address">
                    <div class="weui-cell norms">
                    </div>
                    <div class="weui-cell buyNum">
                        <div class="weui-cell__bd f14">购买数量：</div>
                        <div class="weui-cell__ft">
                            <i class="icon iconfont icon-l-reduce f20 vux-number-selector-sub"></i>
                            <input class="f16 input-number-int" pattern="[1-100]*" name="listen" value="1"
                                   id="acn_quertity">
                            <i class="icon iconfont icon-l-jia f20  vux-number-selector-plus"></i>
                        </div>
                    </div>
                    <a class="weui-cell btn" href="javascript:;">
                        <div class="weui-cell__bd f14" id="acn_confirm">确认</div>
                    </a>
                </div>
                <div class="weui-actionsheet__action cancel">
                    <i class="iconfont icon-remove-02"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="page__bd product_style" style="height: 100%;">
        
<!--BEGIN dropmenu-->

<div class="dropmenu">
    <div class="weui-navbar hd " id="navbar">
        <div class="weui-navbar__item">
            <span class="f14"><span class="navbar2 over-flow_omit">全部类别</span> <i class="iconfont icon-xiajiantou"></i></span>
        </div>
        <div class="weui-navbar__item">
            <span class="f14"><span class="navbar3 over-flow_omit">智能排序</span> <i class="iconfont icon-xiajiantou"></i></span>
        </div>
    </div>
    <div id="style">
        <i class="iconfont icon-details style col-1" id="goods_style"></i>
    </div>
    <div class="bd" id="nav_menu">
        <div class="weui-flex menu categoryd" style="display:none">
        </div>
        <div class="weui-flex menu orderd" style="display:none;margin-top:0; text-align: center;">
        </div>
    </div>
    <div id="mask" style=""></div>
</div>
<!--<div id="mask" style=""></div>-->
<!--END dropmenu-->

        <div class="weui-tab pageable" style="margin-top: 44px;">
            <div class="product-list product_search hot_product weui-cells product" style="margin-top:0;"></div>
        </div>
        <div class="go-carts">
            <a href="../carts/cart.html" class="weui-tabbar__item Ftext">
              <span class="weui-badges">
                <i class="icon iconfont icon-gouwuche" style="font-size:20px;"></i>
              <span class="weui-badge f12" style="display: inline-block;top:-5px;">1</span>
              </span>
            </a>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        var jsonsData = {
            pageSize: 20,
            pageNumber: 1
        };
        jsonsData.brandId = pageManager.GetQueryString("cateId");
        dropmenu.init("全城", pageManager.GetQueryString("categoryName"), "智能排序");
        var ar = new area(function (data) {
            dropmenu.bindCity(data, function (data) {
                jsonsData.areaId = data.areaId;
                jsonsData.communityId = data.communityId;
                loadUpFn();
            });
            //热门商圈
            var h = render.fill($("#tpl_hotArea"), data);
            $(".hot").html(h);
        });
        ar.community();
        //initCategory();
        initCategoryBrand();
        dropmenu.bindCategory(getBrandChildRens(pageManager.GetQueryString("categoryId")), function (data) {
            jsonsData.brandId = data.categoryId;
            loadUpFn();
        });
        dropmenu.bindOrder(["智能排序", "价格由低到高", "价格由高到低", "销量优先", "评论最高"], function (data) {
            var orderType = "";
            if (data == 0) {
                orderType = "weight";
            }
            if (data == 1) {
                orderType = "priceAsc";
            }
            if (data == 2) {
                orderType = "priceDesc";
            }
            if (data == 3) {
                orderType = "salesDesc";
            }
            if (data == 4) {
                orderType = "scoreDesc";
            }
            jsonsData.orderType = orderType;
            loadUpFn();
        });

        var loadUpFn = function () {
            var tu = new product(function (data) {
                jsonsData.pageNumber += 1;
                var h = render.fill($("#tpl_productList"), data);
                $(".pageable .product-list").html(h);
                // pged.unlock();
                //pged.noData(false);
                pged.resetload();
            });
            jsonsData.pageNumber = 1;
            tu.list(jsonsData);
        };

        var pged = $(".pageable").pageable({
                    loadUpFn: function (me) {
                        loadUpFn();
                    },
                    loadDownFn: function (me) {
                        var td = new product(function (data) {
                            jsonsData.pageNumber += 1;
                            var h = render.fill($("#tpl_productList"), data);
                            $(".pageable .product-list").append(h);
                            if (data.length < jsonsData.pageSize) {
                                me.lock();
                                me.noData();
                            }
                            me.resetload();
                        });
                        td.list(jsonsData);
                    }
                }
        );


        //搜索结果页点击切换商品样式
        $('#goods_style').on('click', function () {
            $(this).toggleClass('col-2');
            if ($('#goods_style').hasClass('col-2')) {
                $('.product').addClass('product-grid').removeClass('product-list');
            }
            else {
                $('.product').addClass('product-list').removeClass('product-grid');
            }
        });

    });
    $(function () {

        var init_spec = function (thumbnail, price, stock, spec) {
            if (thumbnail) $("#acn_thumbnail")[0].src = thumbnail;
            $("#acn_price").text('￥' + (price ? price : 0));
            $("#acn_stock").text((stock ? stock : 0));
            $("#acn_choose").html(spec ? '已选 <font color="#ff6d06">' + spec + '</font>' : '请选择商品规格');
        };

        new product(function (data) {
            weixin.share({
                title: data.title,
                desc: data.desc,
                link: data.link,
                imgUrl: data.imgUrl
            });
        }).share({id: pageManager.GetQueryString('id')});
        var productId;//选中商品Id
        var specification;//当前商品规格
        var specifications;//所有规格及对应的规格值
        var productSpecifications;//所有商品规格
        var $norms = $(".norms");
        var jd_id;
        new product(function (data) {
            //商品信息
            var h = render.fill($("#tpl_productDetailsDesc"), data);
            $(".product_desc").html(h);
            if (data.marketPrice == 0) {
                $('#marketPrice').html('');
            }

            //商品规格初始化
            specification = data.specification;
            specifications = data.specifications;
            productSpecifications = data.productSpecifications;

            if (specification.length == 0) $norms.show();
            var html = '';
            $.each(specifications, function (i, v) {
                html += '<h2 class="f14">' + v.name + '：</h2>';
                html += '<ul class="f14">';
                $.each(v.specificationValues, function (i1, v1) {
                    var flag = false;
                    $.each(specification, function (i2, v2) {
                        if (v2.id == v.id && v2.specificationValueId == v1.id) flag = true;
                    });
                    //默认选中当前商品规格
                    html += '<li specificationId="' + v.id + '" specificationValueId="' + v1.id + '" class="' + (flag ? "active" : "") + '"><a href="javacript:;">' + v1.name + '</a></li>';
                });
                html += '</ul>';
            });
            $norms.html(html);
            productId = data.id;
            var spec = '';
            $.each(specification, function (i, v) {
                spec += i == 0 ? v.name : ' ' + v.name;
            });
            init_spec(data.thumbnail, data.price, data.availableStock, spec);
            if (specification.length == 2) {
                matchSpec($norms.find('ul').eq(0).find('li.active'), $norms.find('ul').eq(1).find('li'));
                matchSpec($norms.find('ul').eq(1).find('li.active'), $norms.find('ul').eq(0).find('li'));
            }

        }).view({id: pageManager.GetQueryString("id")});

        //添加商品到收藏/取消收藏
        $(document).on('click', '#product_collect', function () {
            var favorite = $('.proFavorite').text();
            if (favorite == 'true') {
                new product(function (data) {
                    $('.proFavorite').text('false');
                    $('#product_collect>i').addClass('icon-l-star').removeClass('icon-s-star');
                }).delFavorite({id: pageManager.GetQueryString("id")});
            } else {
                new product(function (data) {
                    $('.proFavorite').text('true');
                    $('#product_collect>i').addClass('icon-s-star').removeClass('icon-l-star');
                }).favorite({id: pageManager.GetQueryString("id")});
            }
        });


        //下面演示用js
        $('#product_collect').on('click', function () {
            $("#product_collect i").toggleClass("icon-s-star");
        });


        //点击事件
        $(document).on('click', '.norms ul li', function () {
            var $this = $(this), spec1, spec2;
            if ($this.hasClass('disabled')) return;//禁用项不可点击
            $this.addClass('active').siblings('.active').removeClass('active');
            var $activeLi = $norms.find('ul li.active');//选中的规格项
            //只有一种规格
            if (specification.length == 1) {
                if ($activeLi.length == 0) {
                    productId = '';
                    init_spec();
                } else if ($activeLi.length == 1) {
                    spec1 = {
                        id: $activeLi.attr("specificationId"),
                        valueId: $activeLi.attr("specificationValueId")
                    };
                    $.each(productSpecifications, function (i, v) {
                        $.each(v.specifications, function (i1, v1) {
                            if (spec1.id == v1.id && spec1.valueId == v1.specificationValueId) {
                                productId = v.id;
                                init_spec(v.thumbnail, v.price, v.availableStock, v1.name);
                            }
                        });
                    });
                }
                //两种规格
            } else if (specification.length == 2) {
                if ($activeLi.length == 0) {//两个规格都没选中
                    $norms.find('ul li').removeClass('disabled');//全部规格值启用
                    productId = '';
                    init_spec();
                } else if ($activeLi.length == 1) {//只有一个规格被选中
                    $activeLi.parent().find('li').removeClass('disabled');//启用选中规格下的所有规格值
                    matchSpec($activeLi, $activeLi.parent().siblings("ul").find("li"));
                    productId = '';
                    init_spec();
                } else if ($activeLi.length == 2) {//两个规格被选中
                    matchSpec($this, $this.parent().siblings("ul").find("li"));
                    spec1 = {//当前点击选中的规格
                        id: $this.attr("specificationId"),
                        valueId: $this.attr("specificationValueId")
                    };
                    var $anotherLi = $this.parent().siblings("ul").find(".active");//另一个被选中的li
                    spec2 = {//另一个被选中的规格
                        id: $anotherLi.attr("specificationId"),
                        valueId: $anotherLi.attr("specificationValueId")
                    };
                    $.each(productSpecifications, function (i, v) {
                        var flag1 = false, flag2 = false;
                        var spec = '';
                        $.each(v.specifications, function (i1, v1) {
                            if (spec1.id == v1.id && spec1.valueId == v1.specificationValueId) flag1 = true;
                            if (spec2.id == v1.id && spec2.valueId == v1.specificationValueId) flag2 = true;
                            spec += i1 == 0 ? v1.name : ' ' + v1.name;
                        });
                        if (flag1 && flag2) {//区配到商品
                            productId = v.id;
                            init_spec(v.thumbnail, v.price, v.availableStock, spec);
                        }
                    });
                }
            }

            var num = parseInt($('#acn_quertity').val());
            var nums3 = parseInt($("#acn_stock").text());
            if (num > nums3) {
                $('#acn_quertity').val(nums3);
                toast.show('库存不足！')
            }
        });


        function matchSpec($li, $lis) {
            var spec1 = {
                id: $li.attr("specificationId"),
                valueId: $li.attr("specificationValueId")
            };
            $.each($lis, function () {
                var $this = $(this);
                $this.addClass('disabled');
                var spec2 = {
                    id: $this.attr("specificationId"),
                    valueId: $this.attr("specificationValueId")
                };
                $.each(productSpecifications, function (i, v) {
                    var flag1 = false, flag2 = false;
                    $.each(v.specifications, function (i1, v1) {
                        if (spec1.id == v1.id && spec1.valueId == v1.specificationValueId) flag1 = true;
                        if (spec2.id == v1.id && spec2.valueId == v1.specificationValueId) flag2 = true;
                    });
                    if (flag1 && flag2) $this.removeClass('disabled');
                });
            });
        }


// 基类
        var cartobj = {
            init: function () {
                this.cart_calc();
            },
            // 加减
            cart_calc: function () {

                var obj = this;


                // 加
                $('.vux-number-selector-plus').on('click', function () {

                    var valm = $(this).prev('.input-number-int').val();
                    valm = parseFloat(valm) + 1;
                    var num = $("#acn_stock").text();
                    if (valm > num) {
                        valm = num;
                        toast.show('超出库存量！')
                    }

                    $(this).prev('.input-number-int').val(valm);
                });
                // 减
                $('.vux-number-selector-sub').on('click', function () {
                    var valm = $(this).next('.input-number-int').val();
                    valm = parseInt(valm) - 1;
                    if (valm < 1) {
                        valm = 1;
                    }
                    $(this).next('.input-number-int').val(valm);
                });
            }
        };
        cartobj.init();



        //选择商品规格
        $('#sheet_choose_norms').on('click', function () {
            $("#actionSheet_choose_norms").actionsheet();
            $("#acn_confirm").unbind('click').click(function () {
                $("#actionSheet_choose_norms").actionsheetClose();
            });
        });

        //购物车数量
        var cartNum = new product(function (data) {
            if (data.cartCount != 0) {
                $('.weui-badge').css('display', 'inline-block');
                $('.weui-badge').html(data.cartCount);
            } else {
                $('.weui-badge').hide();
            }
        });
        cartNum.view({id: pageManager.GetQueryString("id")});


        //加入购物车
        $(document).on('click', '#sheet_add_card', function () {
            console.log($(this).attr('data-id'));
            jd_id = $(this).attr('data-id');
            $("#actionSheet_choose_norms").actionsheet();
            $("#acn_confirm").unbind('click').click(function () {
                if (!productId) {
                    toast.show('请选择商品规格');
                    return;
                }
                new cart(function (data) {
                    setTimeout(function () {
                        toast.show('加入购物车成功');
                    }, 200);
                    $("#actionSheet_choose_norms").actionsheetClose();

                    //购物车数量
                    if (data.cartCount != 0) {
                        $('.weui-badge').css('display', 'inline-block');
                        $('.weui-badge').html(data.cartCount);
                    } else {
                        $('.weui-badge').hide();
                    }
                }).add({
                    id: productId,
                    quantity: $("#acn_quertity").val()
                });
            });
        });

        //添加增加访问记录
        new visitRecord(function () {
        }).add({
            productId: pageManager.GetQueryString("id"),
            visitType: 'weixin',
            machineType: 'mobile'
        });

    });
</script>


</script>


<!--模版-->
<!--分类点进去的产品列表页模版页-->
<script type="text/html" id="tpl_productList">
<!-- product_list -->
{{#each this}}
<div class="position">
    <a class="weui-cell" href="../product/product-details.html?id={{id}}" data-id="{{id}}" >
        <div class="weui-cell__hd fly_img">
            {{#compare thumbnail '!=' null}}
            <img src="{{thumbnail}}" />
            {{/compare}}
            {{#compare thumbnail '==' null}}
            <img src="../images/placeholder/product.png" />
            {{/compare}}
        </div>
        <div class="weui-cell__bd">
            <p class="Ftitle">{{name}}</p>
            <p class="tag_list">
                {{#each promotions}}
                <i class="iconfont icon-{{type}}"></i>
                {{/each}}
            </p>
            <p class="price f14"><span>￥{{price}}
                {{#compare price '==' marketPrice}}
                {{/compare}}
                {{#compare price '!=' marketPrice}}
                    <i class="marketPrice">￥{{marketPrice}}</i></span>
                {{/compare}}
            </p>
            <p class="Fauxiliary">库存 {{favoriteCount}} /月销量 {{monthSales}}</p>

        </div>
    </a>
    <span class="cart fly_cart_start"  data-id="{{id}}" id="sheet_add_card" ><i class="icon iconfont icon-l-jia"></i></span>
</div>
{{/each}}
<!-- product_list end -->
</script>
<script type="text/html" id="tpl_hotArea">
{{#each hotCommunity}}
    <li class="weui-cell"><span areaid="" communityid="{{id}}">{{name}}</span></li>
{{/each}}
</script>



<script src="/weixin/js/wap.min.js"></script>



<script type="text/javascript">
    $(function () {
        pageManager.show("category");

        weixin.share();//注册分享

        //点击搜索框跳转页面
        $("#searchBar").on('click', function () {
            window.location.href = "../search/searchProduct.html?id=2";
        });

        //initCategory();
        initCategoryBrand();
        //填充左边导航内容
        var cageList = Handlebars.compile($("#Categorys").html());
        $("#silder-left").html(cageList(categoryBrands));

        //获取第一个点击事件然后默认加载第一个
        function getcage(id) {
            var obj = $("#rootProductCategory li").first("data-id");
            $(obj).addClass("active").siblings().removeClass("active");
            var rootId = $(obj).attr("data-id");
            var compiler = Handlebars.compile($("#wap-list-item").html());
            $("#subProductCategory").html(compiler(getBrandChildRens(rootId)));
        }

        //调取第一次加载
        getcage();

        //监听左边导航菜单获取右边分类
        $(".class-items .cage").on("click", function () {
            $(this).addClass("active").siblings().removeClass("active");
            var rootId = $(this).attr("data-id");
            //android机子需要延迟才能正常加载
            setTimeout(function () {
                var compiler = Handlebars.compile($("#wap-list-item").html());
                $("#subProductCategory").html(compiler(getBrandChildRens(rootId)));
                $('.am-list>li').each(function () {
                    var $this = $(this);
                    if ($this.find('ul').length == 0) {
                        $this.hide();
                    }
                });

            }, 10);
        });

        $('.am-list>li').each(function () {
            var $this = $(this);
            if ($this.find('ul').length == 0) {
                $this.hide();
            }
        });

        $(document).on("click", ".aproductReasult", function () {
            var first = $(this).parents(".category-ctn-right").prev().find("li.active");
            var cate = $(this).attr('data-id');
            location.href = 'category.html?categoryId=' + first.attr("data-id") + '&categoryName=' + escape($(this).find(".f12").text()) + '&cateId=' + cate + '#productReasult';
        });

        //滚动高度固定
        var viewHeight = window.innerHeight || document.documentElement.clientHeight;
        var topHeight = $(".weui-search-bar").height();
        var bottomHeight = viewHeight - topHeight - 51;
        document.getElementById("silder-left").style.height = bottomHeight + "px";
        document.getElementById("silder-right").style.height = bottomHeight + "px";
    });
</script>
</body>
</html>

