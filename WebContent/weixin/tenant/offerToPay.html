<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
    <title>商家首页</title>
    
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="stylesheet" href="/weixin/style/wap.min.css"/>
<script src="/weixin/js/zepto.min.js"></script>
<script src="/weixin/js/callbacks.js"></script>
<script src="/weixin/js/deferred.js"></script>
<script src="/weixin/js/handlebars.min.js"></script>
<script src="/weixin/js/lazyload.min.js"></script>
<script src="/weixin/js/iSlider.min.js"></script>
<script src="/weixin/js/iSlider.animate.min.js"></script>
<script src="/weixin/js/fly.min.js"></script>
<script src="/weixin/js/requestAnimationFrame.js"></script>
<script src="/weixin/js/iscroll.js"></script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>


  

</head>
<body ontouchstart>
<div class="weui-toptips weui-toptips_warn js_tooltips">错误提示</div>
<script type="text/html" id="tpl_toast">

    <!--BEGIN toast-->
    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-info-circle weui-icon_toast"></i>
            <p class="weui-toast__content">已完成</p>
        </div>
    </div>
    <!--end toast-->

    <!-- loading toast -->
    <div id="loadingToast" style="display:none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-loading weui-icon_toast"></i>
            <p class="weui-toast__content">努力加载</p>
        </div>
    </div>

</script>
<script type="text/html" id="tpl_dialog">

    <!--BEGIN dialog1-->
    <div id="dialog1" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title">弹窗标题</strong></div>
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default">否</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">是</a>
            </div>
        </div>
    </div>
    <!--END dialog1-->
    <!--BEGIN dialog2-->
    <div id="dialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">知道了</a>
            </div>
        </div>
    </div>
    <!--END dialog2-->

</script>
<div class="container" id="container"></div>


<!--联系商家-->
<script type="text/html" id="tpl_offerToPay">
<div class="page">
    

    <!--BEGIN toast-->
    <div id="toast" style="display: none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-icon-info-circle weui-icon_toast"></i>
            <p class="weui-toast__content">已完成</p>
        </div>
    </div>
    <!--end toast-->

    <!-- loading toast -->
    <div id="loadingToast" style="display:none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <!--<i class="weui-loading weui-icon_toast"></i>-->
            <p class="weui-toast__content">努力加载</p>
        </div>
    </div>


    

    <!--BEGIN dialog1-->
    <div id="dialog1" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__hd"><strong class="weui-dialog__title">操作提示</strong></div>
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default">否</a>
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">是</a>
            </div>
        </div>
    </div>
    <!--END dialog1-->
    <!--BEGIN dialog2-->
    <div id="dialog2" style="display: none;">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
            <div class="weui-dialog__bd">弹窗内容，告知当前状态、信息和解决方法，描述文字尽量控制在三行内</div>
            <div class="weui-dialog__ft">
                <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">知道了</a>
            </div>
        </div>
    </div>
    <!--END dialog2-->


    <!--BEGIN actionSheet-商家优惠券-->
    <div id="actionSheet_merchant_coupons">

    </div>
    <!--END actionSheet-商家优惠券-->
    <div class="page__bd" style="height: 100%;">
        <div class="weui-tab">
            <!-- BEGIN offerToPay -->
            <div class="offer_toPay">

                <div class="aadress none" id="sheet_choose_store">
                    <p class="f14" id="delivery_name">唯爱婴元一名城店</p>
                    <p class="Fauxiliary" id="delivery_address">瑶海区中绿广场二期三百米</p>
                </div>

                <div class="weui-cells hd">
                    <div class="weui-cell">
                        <div class="weui-cell__hd f14">消费总额：</div>
                        <div class="weui-cell__bd">
                            <input class="f14" type="number" id="amount" placeholder="输入到店消费总额">
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd">
                            <input hidden="" type="checkbox" id="ckBoxMoney">
                            <label id="ckBoxIco" class="iconfont icon-l-square f14" for="ckBoxMoney"></label>
                        </div>
                        <div class="weui-cell__bd f14">
                            输入不参与优惠金额
                        </div>
                    </div>
                    <div class="weui-cell money none">
                        <div class="weui-cell__hd f14">不参与优惠金额：</div>
                        <div class="weui-cell__bd">
                            <input class="f14" type="number" id="noAmount" placeholder="询问商家收银员后输入">
                        </div>
                    </div>
                </div>
                <div class="weui-cells bd" id="tenant_coupon">
                    <div class="weui-cell weui-cell_access sheet_merchant_coupons none" id="tenant_coupon_title">
                        <div class="weui-cell__hd"></div>
                        <div class="weui-cell__bd f14 "><span class="cou">商家优惠券</span></div>
                        <div class="weui-cell__ft"></div>
                    </div>
                    <div class="weui-cell" id="tenant_coupon_1">
                        <div class="weui-cell__hd">?</div>
                        <div class="weui-cell__bd">
                            <p class="f14">更多优惠</p>
                            <p>敬请期待</p>
                        </div>
                        <div class="mask_l"></div>
                        <div class="mask_r"></div>
                    </div>
                    <div class="weui-cell none" id="tenant_coupon_2" style="padding: 1em">
                        <div class="weui-cell__bd">
                            <div class="weui-cell">
                                <div class="weui-cell__hd">￥<span id="coupon_amount"></span></div>
                                <div class="weui-cell__bd f14">
                                    <p>满<span id="coupon_minimumPrice">0</span>可用</p>
                                    <p>优惠券</p>
                                </div>
                            </div>
                            <div class="f14 clr-LightGray">使用期限：<span id="coupon_date">2016.11.11-2017.01.11</span></div>
                        </div>
                        <div class="weui-cell__ft">
                            <i class="iconfont icon-s-selected f14"></i>
                        </div>
                        <div class="mask_l"></div>
                        <div class="mask_r"></div>
                    </div>
                </div>
                <div class="weui-cells bd none" id="isBillDiscount">
                    <div class="weui-cell weui-cell_access">
                        <div class="weui-cell__hd"></div>
                        <div class="weui-cell__bd f14"><span class="cou">商家折扣</span></div>
                    </div>
                    <div class="weui-cell" style="padding: 1em">
                        <div class="weui-cell__bd">
                            <p class="Ftitle" id="promotionName">光混节折扣</p>
                            <p class="Fauxiliary" id="promotionDate">2016.11.02-2016.11.08</p>
                        </div>
                        <div class="weui-cell__ft orange f14">-￥<span id="promotionAmount">2.2</span></div>
                        <div class="mask_l"></div>
                        <div class="mask_r"></div>
                    </div>
                </div>

                <div class="weui-cells pay-money" id="isActivityTenant">
                    <div class="weui-cell f14">
                        <div class="weui-cell__hd">平台优惠：</div>
                        <div class="weui-cell__bd">￥<span id="activityAmount">0</span></div>
                    </div>
                </div>
                <div class="weui-cells pay-money">
                    <div class="weui-cell f14">
                        <div class="weui-cell__hd">实付金额：</div>
                        <div class="weui-cell__bd">￥<span id="payAmount">0</span></div>
                    </div>
                </div>
                <div class="weui-cells ft" style="background: none;">
                    <div class="weui-cell">
                        <a class="weui-cell__bd" href="javascript:;" id="confirmPayBill">确认买单</a>
                    </div>

                </div>
            </div>
            <!-- BEGIN offerToPay end-->
        </div>
    </div>
</div>

<script type="text/javascript">
    $(function () {
        document.title='优惠买单';
        //注册分享
        new tenant(function (data) {
            weixin.share({
                title:data.title,
                desc:data.desc,
                link:data.link,
                imgUrl:data.imgUrl
            });
        }).offerToPayShare({
            id:pageManager.GetQueryString('id')
        });

        $(document).on('click','#ckBoxMoney', function () {

            if($('#amount').val() == '' || $('#amount').val() < 0){

                $('#ckBoxMoney').checked='false';

            }else{
                if($('#ckBoxMoney').prop('checked')==true){
                    $('#ckBoxIco').removeClass('icon-l-square').addClass('icon-s-square');
                    $('.money').removeClass('none');
                }else{
                    $('#ckBoxIco').removeClass('icon-s-square').addClass('icon-l-square');
                    $('.money').addClass('none');
                }
            }
        });

        //获取最近实体店
        weixin.location(function () {
            new paybill(function (data) {
                console.log(data);
                $('#sheet_choose_store').attr('delivery_id', data.id).show();
                $('#delivery_name').text(data.name);
                $('#delivery_address').text(data.address);
            }).deliveryCenter({
                id: pageManager.GetQueryString('id'),
                lat: weixin.lat,
                lng: weixin.lng
            });
        });

        var t1;
        var t2;
        $('body').on('input', '#amount', function () {
            clearTimeout(t1);
            var obj=this;
            t1=setTimeout(function () {
                onAmount(obj)
            },500);
        }).on('input','#noAmount',function () {
            clearTimeout(t2);
            var obj=this;
            t2=setTimeout(function () {
                onNoAmount(obj)
            },500);
        });

        var onAmount=function (obj) {
            if(obj.value > 0){
                getamount(obj.value);
            }else{
                $('#ckBoxMoney').prop('checked','false');
                $('#ckBoxIco').removeClass('icon-s-square').addClass('icon-l-square');
                $('.money').addClass('none');
                $('#tenant_coupon_1').removeClass('none');
                $('#isBillDiscount').addClass("none");
                $('#tenant_coupon_2').addClass('none');
                $('#activityAmount').text(0);
                $('#payAmount').text(0);
                $('#confirmPayBill').removeClass('active');
            }
        };

        var onNoAmount=function (obj) {
            if (Number(obj.value) > Number($('#amount').val())) {
                setTimeout(function () {
                    toast.show('不参与优惠金额不得大于消费总额');
                },200);
                obj.value = $('#amount').val();
            }
            getamount(obj.value);
        };

        function getamount(){
            new paybill(function(data){
                console.log(data);
                if(data.hasPromotion){
                    $('#tenant_coupon_1').addClass('none');
                    $('#isBillDiscount').removeClass("none");
                    $('#promotionName').text(data.promotionName);
                    $('#promotionAmount').text(data.promotionAmount);
                    $('#promotionDate').text(data.promotionDate);
                }else if (data.coupon){
                    $('#tenant_coupon_1').addClass('none');
                    $('#tenant_coupon_2').removeClass('none');
                    $('#coupon_amount').text(data.coupon.amount);
                    $('#coupon_minimumPrice').text(data.coupon.minimumPrice);
                    $('#coupon_date').text(data.coupon.effectiveDate);
                }else {
                    $('#tenant_coupon_1').removeClass('none');
                    $('#tenant_coupon_2').addClass('none');
                    $('#isBillDiscount').addClass('none');
                }
                if(data.platformDiscount>0){
                    $('#activityAmount').text(data.platformDiscount);
                }
                $('#payAmount').text(data.decimal);
                $('#confirmPayBill').addClass('active');
            }).getAmount({
                id: pageManager.GetQueryString('id'),
                amount: $('#amount').val(),
                noAmount: $('#ckBoxMoney').prop('checked') ? $('#noAmount').val() : ''
            });
        }

        //提交
        $('#confirmPayBill').click(function () {
            if (!$(this).hasClass('active')) return;
            var deliverCenterId = $('#sheet_choose_store').attr('delivery_id');
            new paybill(function (data) {
                location.href = '/weixin/payment/pay.html?sn=' + data.sn;
            }).submit({
                id: pageManager.GetQueryString('id'),
                amount: $('#amount').val(),
                noAmount: $('#ckBoxMoney').prop('checked') ? $('#noAmount').val() : '',
                deliveryCenterId: deliverCenterId ? deliverCenterId : ''
            });
        });
    });
</script>
</script>


<!--模版-->
<script type="text/html" id="tpl_tenantCoupons">
<div class="weui-mask_transparent actionsheet__mask" style="opacity: 0;display: none;"></div>
<div class="weui-actionsheet actionsheet">
    <div class="weui-cells address">
        {{#each this}}
        <a class="weui-cell weui-cell_access" href="javascript:;">
            <div class="weui-cell__bd">
                <p class="f14 clr-orange">{{amount}}元</p>
                <p class="f12">订单满{{minimumPrice}}元使用（不含邮费）</p>
                <p class="f12 clr-LightGray">使用日期：{{effectiveDate}}</p>
            </div>
        </a>
        {{/each}}
    </div>
    <div class="weui-actionsheet__action cancel">
        <i class="iconfont icon-remove-02"></i>
    </div>
</div>


</script>
<script type="text/html" id="tpl_tenantAddress">
{{#each this}}
<a class="weui-cell weui-cell_access" href="tenant-contact.html?id={{id}}" data-id="{{id}}">
    <div class="weui-cell__bd">
        <p class="Ftext">{{areaName}}</p>
        <p class="f14" id="name">{{name}}</p>
        <p class="Ftext" id="address">{{address}}</p>
    </div>
    <div class="weui-cell__ft">
    </div>
</a>
{{/each}}
</script>




<script src="/weixin/js/wap.min.js"></script>



<script type="text/javascript">
    $(function () {
        pageManager.show("offerToPay");
    });
</script>
</body>
</html>

