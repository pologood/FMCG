!function(t){function e(e){var o=arguments;return 0===this.length&&".NULL"==this.selector?null:this.each(function(){var n=t(this),r=n.data("TH.chooseCS");r?"string"==typeof e?r[e]({externalcall:!0,params:Array.prototype.slice.call(o,1)}):t.info("Method "+e+" does not exist on Zepto.chooseCS"):"object"!=typeof e&&e||(r=new ChooseCS(this,e),n.data("TH.chooseCS",r))})}ChooseCS=function(e,o){this.$ele=t(e),this.$body=t(document.body),this.options=t.extend(!0,{},ChooseCS.DEFAULTS,o),this.filters_produced=[],this.quantity=1,this.init_imgthumbsrc="",this.colors=[],this.specs=[],this.init(),this.$ele.on("click.chooseCS.condnbtn",'[jhk="condn-btn"]',t.proxy(this.condBtnClickHandler,this)),this.$ele.on("click.chooseCS.minus",'[jhk="opera_minus"]',t.proxy(this.quantityMinus,this)),this.$ele.on("click.chooseCS.add",'[jhk="opera_add"]',t.proxy(this.quantityAdd,this))},ChooseCS.VERSION="1.0.0",ChooseCS.DEFAULTS={filters_predefine:[{property:"color",description:"颜色分类"},{property:"spec",description:"型号规格"}]},ChooseCS.prototype.getProductId=function(){var t=this;if(arguments[0].externalcall){var e={};if(e.callback=arguments[0].params[0],t.$ele.find(".condn-btn.chosen").length!==t.filters_produced.length)e.callback(null);else{var o=t._getProduct();e.callback(o.id),console.log("filter_result's value is as following:"),console.log(filter_result)}}},ChooseCS.prototype._getProduct=function(){var e=this,o=[],n=e.$ele.find(".condn-btn.chosen");return n.each(function(e,n){var r=t(n).closest(".condn").data("filter-property");o.push({property:r,value:t(n).text()})}),t.grep(e.options.initialdatas,function(t){return 0===o.length,1===o.length&&t[o[0].property]==o[0].value||(2===o.length&&t[o[0].property]==o[0].value&&t[o[1].property]==o[1].value||void 0)})[0]},ChooseCS.prototype.getProductIdAndQuantity=function(){var e=this;if(arguments[0].externalcall){var o={};if(o.callback=arguments[0].params[0],0===e.filters_produced.length)return void o.callback(0,e.quantity);if(e.$ele.find(".condn-btn.chosen").length!==e.filters_produced.length)o.callback(null);else{var n=[],r=e.$ele.find(".condn-btn.chosen");r.each(function(e,o){var r=t(o).closest(".condn").data("filter-property");n.push({property:r,value:t(o).text()})});var s=t.grep(e.options.initialdatas,function(t){return 0===n.length,1===n.length&&t[n[0].property]==n[0].value||(2===n.length&&t[n[0].property]==n[0].value&&t[n[1].property]==n[1].value||void 0)})[0];o.callback(s.id,e.quantity)}}},ChooseCS.prototype.getQuantity=function(){var t=this;if(arguments[0].externalcall){var e={};e.callback=arguments[0].params[0],e.callback&&e.callback(t.quantity)}},ChooseCS.prototype.quantityMinus=function(e){var o=this,n=t(e.target);o.quantity>1&&n.closest(".addminus").children("b").text(--o.quantity)},ChooseCS.prototype.quantityAdd=function(e){var o=this,n=t(e.target);o.quantity<9998&&n.closest(".addminus").children("b").text(++o.quantity)},ChooseCS.prototype.refreshDashBoard=function(){var t=this,e=t.$ele.find('[jhk="imgthumb"]'),o=t.$ele.find('[jhk="price"]'),n=t.$ele.find('[jhk="stock"]'),r=t.$ele.find('[jhk="chosenconds-desc"]'),s=t.$ele.find('[jhk="chosenconds"]'),i=t.$ele.find(".condn-btn.chosen");if(i.length!==t.filters_produced.length)r.text("请选择颜色或型号"),s.text(""),t.options.initialdatas.length?e.attr("src",t.options.initialdatas[0].thumbnail):e.attr("src",t.init_imgthumbsrc),o.text("0"),n.text("0");else{var l=t._getProduct(),c="";e.attr("src",l.thumbnail),o.text(l.price),n.text(l.stock);for(var a=0;a<i.length;a++)c=c+i.eq(a).text()+"  ";r.text("已选"),s.text(c)}},ChooseCS.prototype.condBtnClickHandler=function(e){var o=this,n=t(e.target);if(1===o.filters_produced.length){if(n.hasClass("sorry_no"))return;n.toggleClass("chosen").siblings().not(".sorry_no").removeClass("chosen"),o.refreshDashBoard()}if(2===o.filters_produced.length){if(n.hasClass("sorry_no"))return;var r=n.closest(".condn").siblings(".condn"),s=n.closest(".condn").data("filter-property"),i=r.data("filter-property"),l=[],c=[];l=t.grep(o.options.initialdatas,function(t){if(t[s]==n.text())return!0});for(var a=0;a<l.length;a++)t.inArray(l[a][i],c)<0&&c.push(l[a][i]);var d=r.find(".condn-btn").addClass("sorry_no");if(d.each(function(e,o){t.inArray(t(o).text(),c)>=0&&t(o).removeClass("sorry_no")}),r.find(".condn-btn.chosen").length&&n.hasClass("chosen"))return n.removeClass("chosen"),r.find(".condn-btn.chosen").siblings().removeClass("sorry_no"),void o.refreshDashBoard();if(0===r.find(".condn-btn.chosen").length&&n.hasClass("chosen"))return n.removeClass("chosen"),r.find(".condn-btn").removeClass("sorry_no"),void o.refreshDashBoard();n.toggleClass("chosen").siblings().not(".sorry_no").removeClass("chosen"),o.refreshDashBoard()}},ChooseCS.prototype.getProcessFilters=function(){for(var e=this,o=e.options.initialdatas,n=e.options.filters_predefine,r=0;r<n.length;r++)e.filters_produced[r]||(e.filters_produced[r]={}),t.extend(!0,e.filters_produced[r],n[r],{content:[]});for(var s=0;s<o.length;s++)for(var i=0;i<e.filters_produced.length;i++)t.inArray(o[s][e.filters_produced[i].property],e.filters_produced[i].content)<0&&e.filters_produced[i].content.push(o[s][e.filters_produced[i].property]);for(var l=[],c=0;c<e.filters_produced.length;c++)1==e.filters_produced[c].content.length&&""==e.filters_produced[c].content[0]||l.push(e.filters_produced[c]);return e.filters_produced=l,console.log("filters_produced is"),console.log(e.filters_produced),e.filters_produced},ChooseCS.prototype.build=function(){var e=t.Deferred(),o=this;return setTimeout(function(){var n={filters_produced:o.getProcessFilters()},r=Handlebars.compile(t("#"+o.options.tplid).html());o.$ele.html(r(n)),e.resolve()},0),e.promise()},ChooseCS.prototype.init=function(){var e=this;t.when(e.build()).done(function(){if(e.init_imgthumbsrc=e.$ele.find('[jhk="imgthumb"]').attr("src"),e.options.initialdatas.length){var o=e.options.initialdatas[0];e.$ele.find('[jhk="imgthumb"]').attr("src",o.thumbnail),e.$ele.find('[jhk="price"]').text(o.price),e.$ele.find('[jhk="stock"]').text(o.stock),e.$ele.find('[jhk="chosenconds-desc"]').text("")}e.$ele.trigger(t.Event("initialized:chooseCS"))}).fail(function(){console.log("网络异常")})};var o=t.fn.chooseCS;t.fn.chooseCS=e,t.fn.chooseCS.Constructor=ChooseCS,t.fn.chooseCS.noConflict=function(){return t.fn.chooseCS=o,this}}(Zepto);