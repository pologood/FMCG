!function(e){function t(t){var o=arguments;return 0===this.length&&".NULL"==this.selector?null:this.each(function(){var n=e(this),r=n.data("TH.chooseCS");r?"string"==typeof t?r[t]({externalcall:!0,params:Array.prototype.slice.call(o,1)}):e.info("Method "+t+" does not exist on Zepto.chooseCS"):"object"!=typeof t&&t||(r=new ChooseCS(this,t),n.data("TH.chooseCS",r))})}ChooseCS=function(t,o){this.$ele=e(t),this.$body=e(document.body),this.options=e.extend(!0,{},ChooseCS.DEFAULTS,o),this.filters_produced=[],this.quantity=1,this.init_imgthumbsrc="",this.colors=[],this.specs=[],this.init(),this.$ele.on("click.chooseCS.condnbtn",'[jhk="condn-btn"]',e.proxy(this.condBtnClickHandler,this)),this.$ele.on("click.chooseCS.minus",'[jhk="opera_minus"]',e.proxy(this.quantityMinus,this)),this.$ele.on("click.chooseCS.add",'[jhk="opera_add"]',e.proxy(this.quantityAdd,this))},ChooseCS.VERSION="1.0.0",ChooseCS.DEFAULTS={filters_predefine:[{property:"color",description:"颜色分类"},{property:"spec",description:"型号规格"}]},ChooseCS.prototype.getProductId=function(){var e=this;if(arguments[0].externalcall){var t={};if(t.callback=arguments[0].params[0],e.$ele.find(".condn-btn.chosen").length!==e.filters_produced.length)t.callback(null);else{var o=e._getProduct();t.callback(o.id),console.log("filter_result's value is as following:"),console.log(filter_result)}}},ChooseCS.prototype._getProduct=function(){var t=this,o=[],n=t.$ele.find(".condn-btn.chosen");return n.each(function(t,n){var r=e(n).closest(".condn").data("filter-property");o.push({property:r,value:e(n).text()})}),e.grep(t.options.initialdatas,function(e){return 0===o.length,1===o.length&&e[o[0].property]==o[0].value||(2===o.length&&e[o[0].property]==o[0].value&&e[o[1].property]==o[1].value||void 0)})[0]},ChooseCS.prototype.getProductIdAndQuantity=function(){var t=this;if(arguments[0].externalcall){var o={};if(o.callback=arguments[0].params[0],0===t.filters_produced.length)return void o.callback(0,t.quantity);if(t.$ele.find(".condn-btn.chosen").length!==t.filters_produced.length)o.callback(null);else{var n=[],r=t.$ele.find(".condn-btn.chosen");r.each(function(t,o){var r=e(o).closest(".condn").data("filter-property");n.push({property:r,value:e(o).text()})});var s=e.grep(t.options.initialdatas,function(e){return 0===n.length,1===n.length&&e[n[0].property]==n[0].value||(2===n.length&&e[n[0].property]==n[0].value&&e[n[1].property]==n[1].value||void 0)})[0];o.callback(s.id,t.quantity)}}},ChooseCS.prototype.getQuantity=function(){var e=this;if(arguments[0].externalcall){var t={};t.callback=arguments[0].params[0],t.callback&&t.callback(e.quantity)}},ChooseCS.prototype.quantityMinus=function(t){var o=this,n=e(t.target);o.quantity>1&&n.closest(".addminus").children("b").text(--o.quantity)},ChooseCS.prototype.quantityAdd=function(t){var o=this,n=e(t.target);o.quantity<9998&&n.closest(".addminus").children("b").text(++o.quantity)},ChooseCS.prototype.refreshDashBoard=function(){var e=this,t=e.$ele.find('[jhk="imgthumb"]'),o=e.$ele.find('[jhk="price"]'),n=e.$ele.find('[jhk="stock"]'),r=e.$ele.find('[jhk="chosenconds-desc"]'),s=e.$ele.find('[jhk="chosenconds"]'),i=e.$ele.find(".condn-btn.chosen");if(i.length!==e.filters_produced.length)r.text("请选择颜色或型号"),s.text(""),t.attr("src",e.init_imgthumbsrc),o.text("0"),n.text("0");else{var l=e._getProduct(),c="";t.attr("src",l.thumbnail),o.text(l.price),n.text(l.stock);for(var a=0;a<i.length;a++)c+=i.eq(a).text();r.text("已选"),s.text(c)}},ChooseCS.prototype.condBtnClickHandler=function(t){var o=this,n=e(t.target);if(1===o.filters_produced.length){if(n.hasClass("sorry_no"))return;n.toggleClass("chosen").siblings().not(".sorry_no").removeClass("chosen"),o.refreshDashBoard()}if(2===o.filters_produced.length){if(n.hasClass("sorry_no"))return;var r=n.closest(".condn").siblings(".condn"),s=n.closest(".condn").data("filter-property"),i=r.data("filter-property"),l=[],c=[];l=e.grep(o.options.initialdatas,function(e){if(e[s]==n.text())return!0});for(var a=0;a<l.length;a++)e.inArray(l[a][i],c)<0&&c.push(l[a][i]);var d=r.find(".condn-btn").addClass("sorry_no");if(d.each(function(t,o){e.inArray(e(o).text(),c)>=0&&e(o).removeClass("sorry_no")}),r.find(".condn-btn.chosen").length&&n.hasClass("chosen"))return n.removeClass("chosen"),r.find(".condn-btn.chosen").siblings().removeClass("sorry_no"),void o.refreshDashBoard();if(0===r.find(".condn-btn.chosen").length&&n.hasClass("chosen"))return n.removeClass("chosen"),r.find(".condn-btn").removeClass("sorry_no"),void o.refreshDashBoard();n.toggleClass("chosen").siblings().not(".sorry_no").removeClass("chosen"),o.refreshDashBoard()}},ChooseCS.prototype.getProcessFilters=function(){for(var t=this,o=t.options.initialdatas,n=t.options.filters_predefine,r=0;r<n.length;r++)t.filters_produced[r]||(t.filters_produced[r]={}),e.extend(!0,t.filters_produced[r],n[r],{content:[]});for(var s=0;s<o.length;s++)for(var i=0;i<t.filters_produced.length;i++)e.inArray(o[s][t.filters_produced[i].property],t.filters_produced[i].content)<0&&t.filters_produced[i].content.push(o[s][t.filters_produced[i].property]);for(var l=[],c=0;c<t.filters_produced.length;c++)1==t.filters_produced[c].content.length&&""==t.filters_produced[c].content[0]||l.push(t.filters_produced[c]);return t.filters_produced=l,console.log("filters_produced is"),console.log(t.filters_produced),t.filters_produced},ChooseCS.prototype.build=function(){var t=e.Deferred(),o=this;return setTimeout(function(){var n={filters_produced:o.getProcessFilters()},r=Handlebars.compile(e("#"+o.options.tplid).html());o.$ele.html(r(n)),t.resolve()},0),t.promise()},ChooseCS.prototype.init=function(){var t=this;e.when(t.build()).done(function(){if(t.init_imgthumbsrc=t.$ele.find('[jhk="imgthumb"]').attr("src"),1===t.options.initialdatas.length){var o=t.options.initialdatas[0];t.$ele.find('[jhk="imgthumb"]').attr("src",o.thumbnail),t.$ele.find('[jhk="price"]').text(o.price),t.$ele.find('[jhk="stock"]').text(o.stock),t.$ele.find('[jhk="chosenconds-desc"]').text("")}t.$ele.trigger(e.Event("initialized:chooseCS"))}).fail(function(){console.log("网络异常")})};var o=e.fn.chooseCS;e.fn.chooseCS=t,e.fn.chooseCS.Constructor=ChooseCS,e.fn.chooseCS.noConflict=function(){return e.fn.chooseCS=o,this}}(Zepto);